<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VINCLE ‚Äî Conversaci√≥n an√≥nima</title>
  <style>
    :root {
      --bg: #0f1720;
      --card: #0b1220;
      --accent: #60a5fa;
      --accent-hover: #3b82f6;
      --muted: #94a3b8;
      --bubble: #111827;
      --bubble-other: #1e293b;
      --glass: rgba(255,255,255,0.03);
      --border: rgba(255,255,255,0.05);
      color-scheme: dark;
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      overflow: hidden;
    }

    body {
      background: linear-gradient(135deg, #071028 0%, #0a1426 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      position: relative;
    }

    /* Fondo con patr√≥n sutil */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(96, 165, 250, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.03) 0%, transparent 50%);
      z-index: -1;
    }

    /* === HEADER === */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: rgba(11, 18, 32, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      z-index: 1000;
      color: #e6eef8;
      transition: all 0.3s ease;
    }

    header:hover {
      background: rgba(11, 18, 32, 0.98);
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
    }

    .logo {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), #7dd3fc);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #021;
      box-shadow: 0 4px 15px rgba(96, 165, 250, 0.3);
      transition: transform 0.3s ease;
    }

    .logo:hover {
      transform: scale(1.05);
    }

    .header-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .header-subtitle {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--muted);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .header-btn:hover {
      background: rgba(255,255,255,0.06);
      color: #e6eef8;
      border-color: rgba(255,255,255,0.1);
    }

    .header-btn.accent {
      background: var(--accent);
      color: #021;
      border: none;
    }

    .header-btn.accent:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    /* === APP CONTAINER === */
    .app-container {
      width: 100%;
      max-width: 1200px;
      height: calc(100dvh - 60px);
      margin-top: 60px;
      padding: 24px;
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 24px;
      position: relative;
    }

    /* === PANEL LATERAL === */
    .side-panel {
      background: rgba(11, 18, 32, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 24px;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    .side-panel:hover {
      border-color: rgba(255,255,255,0.08);
    }

    .panel-section {
      margin-bottom: 24px;
    }

    .panel-section:last-of-type {
      margin-bottom: 0;
      margin-top: auto;
    }

    .section-title {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 12px;
      font-weight: 500;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .room-controls {
      background: var(--glass);
      border-radius: 12px;
      padding: 18px;
      border: 1px solid var(--border);
    }

    .input-group {
      margin-bottom: 16px;
    }

    .input-label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .styled-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      color: #e6eef8;
      font-size: 15px;
      transition: all 0.2s ease;
    }

    .styled-input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.03);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }

    .styled-input::placeholder {
      color: rgba(148, 163, 184, 0.4);
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .btn-primary {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: #021;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    .btn-secondary {
      padding: 12px 20px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.03);
      color: #e6eef8;
      border-color: rgba(255,255,255,0.1);
    }

    .identity-badge {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--glass);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .emoji-large {
      font-size: 24px;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.03);
      border-radius: 10px;
    }

    .color-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.1);
    }

    .identity-info {
      flex: 1;
    }

    .identity-name {
      font-weight: 600;
      font-size: 16px;
      color: #e6eef8;
    }

    .identity-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    /* === CHAT CONTAINER === */
    .chat-container {
      background: rgba(11, 18, 32, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .chat-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .room-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .room-name {
      font-weight: 600;
      font-size: 18px;
      color: #e6eef8;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .room-id {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .copy-icon {
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.2s ease;
    }

    .copy-icon:hover {
      opacity: 1;
    }

    .room-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .expiry-info {
      font-size: 13px;
      color: var(--muted);
    }

    .online-count {
      font-size: 12px;
      color: #10b981;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* === MESSAGES AREA === */
    .messages-area {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: linear-gradient(180deg, 
        rgba(255,255,255,0.01) 0%,
        transparent 30%,
        transparent 100%);
      scroll-behavior: smooth;
    }

    .message-bubble {
      max-width: 75%;
      padding: 16px 20px;
      border-radius: 18px;
      position: relative;
      line-height: 1.5;
      word-break: break-word;
      animation: messageAppear 0.3s ease-out;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    @keyframes messageAppear {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-bubble.other {
      align-self: flex-start;
      background: var(--bubble-other);
      border-bottom-left-radius: 6px;
    }

    .message-bubble.mine {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--accent), #7dd3fc);
      color: #021;
      border-bottom-right-radius: 6px;
    }

    .message-sender {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .sender-emoji {
      font-size: 16px;
    }

    .sender-name {
      font-weight: 600;
      font-size: 14px;
    }

    .message-text {
      font-size: 15px;
      line-height: 1.5;
    }

    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 8px;
      text-align: right;
    }

    /* === MESSAGE COMPOSER === */
    .message-composer {
      padding: 20px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      align-items: center;
      flex-shrink: 0;
      background: rgba(11, 18, 32, 0.9);
    }

    .composer-input {
      flex: 1;
      padding: 14px 18px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      color: #e6eef8;
      font-size: 15px;
      resize: none;
      min-height: 48px;
      max-height: 120px;
      line-height: 1.5;
      transition: all 0.2s ease;
    }

    .composer-input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.03);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }

    .send-button {
      padding: 14px 24px;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: #021;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 100px;
      justify-content: center;
    }

    .send-button:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* === STATS BAR === */
    .stats-bar {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 24px;
      border-top: 1px solid var(--border);
      background: rgba(11, 18, 32, 0.9);
      font-size: 13px;
      color: var(--muted);
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* === MOBILE PANEL (oculto en desktop) === */
    .mobile-panel {
      display: none;
    }

    /* === RESPONSIVE === */
    @media (max-width: 1024px) {
      .app-container {
        grid-template-columns: 1fr;
        padding: 16px;
        gap: 16px;
      }
      
      .side-panel {
        display: none;
      }
      
      .header-btn span {
        display: none;
      }
      
      .mobile-panel {
        display: block;
      }
    }

    @media (max-width: 768px) {
      .app-container {
        height: calc(100dvh - 60px);
        padding: 0;
        border-radius: 0;
      }
      
      .chat-container {
        border-radius: 0;
        border: none;
      }
      
      .message-bubble {
        max-width: 85%;
      }
      
      .messages-area {
        padding: 16px;
      }
      
      .message-composer {
        padding: 16px;
      }
    }

    /* === UTILITY CLASSES === */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      background: rgba(96, 165, 250, 0.1);
      color: var(--accent);
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 16px 0;
    }

    /* === SCROLLBAR STYLING === */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.02);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.2);
    }

    /* === TYPING INDICATOR === */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 12px 20px;
      background: var(--bubble-other);
      border-radius: 18px;
      align-self: flex-start;
      width: fit-content;
      margin-left: 12px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--muted);
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.6; }
      40% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>

<header>
  <a href="#" class="header-brand">
    <div class="logo">
      <svg viewBox="0 0 48 48" width="24" height="24" fill="#021">
        <circle cx="24" cy="24" r="8" />
        <path d="M24 12C24 12 30 18 30 24C30 30 24 36 24 36" fill="none" stroke="#021" stroke-width="2"/>
        <path d="M24 12C24 12 18 18 18 24C18 30 24 36 24 36" fill="none" stroke="#021" stroke-width="2"/>
      </svg>
    </div>
    <div>
      <div class="header-title">VINCLE</div>
      <div class="header-subtitle">Chat an√≥nimo ‚Ä¢ Sin registro</div>
    </div>
  </a>
  
  <div class="header-actions">
    <button id="roomInfoBtn" class="header-btn">
      <span>üí¨</span>
      <span>Sala activa</span>
    </button>
    <button id="newRoomBtn" class="header-btn accent">
      <span>‚ú®</span>
      <span>Nueva sala</span>
    </button>
  </div>
</header>

<div class="app-container">
  <!-- Panel lateral para desktop -->
  <aside class="side-panel">
    <div class="panel-section">
      <h3 class="section-title">Tu identidad</h3>
      <div class="identity-badge">
        <div class="emoji-large" id="myEmoji">üî∑</div>
        <div class="color-dot" id="myColor"></div>
        <div class="identity-info">
          <div class="identity-name" id="anonLabel">An√≥nimo</div>
          <div class="identity-sub">Color y emoji √∫nicos</div>
        </div>
      </div>
    </div>

    <div class="panel-section">
      <h3 class="section-title">Gestionar sala</h3>
      <div class="room-controls">
        <div class="input-group">
          <label class="input-label">ID de sala</label>
          <input type="text" 
                 id="roomInput" 
                 class="styled-input" 
                 placeholder="Introduce ID o genera uno" 
                 spellcheck="false" />
        </div>
        <div class="button-group">
          <button id="createBtn" class="btn-primary">Unirse/Crear</button>
          <button id="copyBtn" class="btn-secondary">Copiar enlace</button>
        </div>
        <div style="font-size: 12px; color: var(--muted); margin-top: 12px; line-height: 1.4;">
          Comparte el enlace con quien quieras. Los mensajes se borran autom√°ticamente despu√©s de 24 horas.
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="panel-section">
      <h3 class="section-title">Acciones r√°pidas</h3>
      <div style="display: flex; flex-direction: column; gap: 8px;">
        <button id="clearChatBtn" class="btn-secondary">
          <span>üóëÔ∏è</span> Limpiar chat local
        </button>
        <button id="randomRoomBtn" class="btn-secondary">
          <span>üé≤</span> Sala aleatoria
        </button>
        <button id="shareRoomBtn" class="btn-secondary">
          <span>üì§</span> Compartir sala
        </button>
      </div>
    </div>

    <div class="panel-section">
      <div class="stats-bar">
        <div class="stat-item">
          <span>üïí</span>
          <span>Expira en <span id="expiryLabel">24h</span></span>
        </div>
        <div class="stat-item">
          <span>üë§</span>
          <span id="onlineCount">1 en l√≠nea</span>
        </div>
      </div>
    </div>
  </aside>

  <!-- √Årea principal del chat -->
  <main class="chat-container">
    <div class="chat-header">
      <div class="room-info">
        <div class="room-name">
          <span>Sala:</span>
          <span id="roomTitle">Cargando...</span>
          <span class="badge" id="roomPrivacy">P√∫blico</span>
        </div>
        <div class="room-id">
          <span>ID: <span id="roomIdText">-</span></span>
          <span class="copy-icon" id="copyRoomIdBtn" title="Copiar ID">üìã</span>
        </div>
      </div>
      
      <div class="room-meta">
        <div class="expiry-info">
          Mensajes expiran en <span id="expiryTimer">24h</span>
        </div>
        <div class="online-count">
          <span class="status-dot"></span>
          <span id="liveUsers">1</span> en l√≠nea
        </div>
      </div>
    </div>

    <div class="messages-area" id="messages">
      <!-- Mensajes se cargan aqu√≠ -->
      <div class="message-bubble other">
        <div class="message-sender">
          <span class="sender-emoji">üëã</span>
          <span class="sender-name">Sistema</span>
        </div>
        <div class="message-text">
          Bienvenido a VINCLE. Tu identidad es an√≥nima. Los mensajes se borran autom√°ticamente despu√©s de 24 horas.
        </div>
        <div class="message-time">Ahora</div>
      </div>
    </div>

    <div class="message-composer">
      <textarea 
        id="textInput" 
        class="composer-input" 
        placeholder="Escribe tu mensaje aqu√≠ (Enter para enviar, Shift+Enter para nueva l√≠nea)..." 
        rows="1"
        spellcheck="true"></textarea>
      <button id="sendBtn" class="send-button">
        <span>Enviar</span>
        <span>‚Üó</span>
      </button>
    </div>
  </main>
</div>

<!-- Mobile panel (oculto en desktop) -->
<div class="mobile-panel" id="mobilePanel">
  <!-- Contenido m√≥vil aqu√≠ -->
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyXMvncuf1Jhux5dVzDJ_VQe3cw3tIntt",
    authDomain: "vincle-e76dd.firebaseapp.com",
    databaseURL: "https://vincle-e76dd-default-rtdb.firebaseio.com",
    projectId: "vincle-e76dd",
    storageBucket: "vincle-e76dd.firebasestorage.app",
    messagingSenderId: "11807936515",
    appId: "1:11807936515:web:ff67d9da38e956ff62cee6"
  };
  firebase.initializeApp(firebaseConfig);

  // Configuraci√≥n mejorada
  const MESSAGE_EXPIRY_HOURS = 24;
  const ROOM_PARAM = new URLSearchParams(location.search).get('room');
  const DEFAULT_ROOM = ROOM_PARAM || localStorage.getItem('vincle_room') || generateRoomId();

  // Elementos DOM
  const elements = {
    roomInput: document.getElementById('roomInput'),
    createBtn: document.getElementById('createBtn'),
    copyBtn: document.getElementById('copyBtn'),
    messages: document.getElementById('messages'),
    textInput: document.getElementById('textInput'),
    sendBtn: document.getElementById('sendBtn'),
    roomTitle: document.getElementById('roomTitle'),
    roomIdText: document.getElementById('roomIdText'),
    myColor: document.getElementById('myColor'),
    myEmoji: document.getElementById('myEmoji'),
    expiryLabel: document.getElementById('expiryLabel'),
    expiryTimer: document.getElementById('expiryTimer'),
    onlineCount: document.getElementById('onlineCount'),
    liveUsers: document.getElementById('liveUsers'),
    clearChatBtn: document.getElementById('clearChatBtn'),
    randomRoomBtn: document.getElementById('randomRoomBtn'),
    newRoomBtn: document.getElementById('newRoomBtn'),
    copyRoomIdBtn: document.getElementById('copyRoomIdBtn'),
    roomInfoBtn: document.getElementById('roomInfoBtn'),
    shareRoomBtn: document.getElementById('shareRoomBtn')
  };

  // Mejores colores y emojis
  const COLORS = [
    '#60a5fa', '#34d399', '#f59e0b', '#a78bfa', 
    '#f97316', '#10b981', '#8b5cf6', '#06b6d4'
  ];
  
  const EMOJIS = [
    'üî∑', 'üî∂', 'üé≠', 'üë§', 'üïµÔ∏è', 'üé™', '‚ú®', 'üåü',
    'üåô', '‚òÄÔ∏è', 'üî•', 'üíß', 'üåø', 'üçÇ', 'üéØ', 'üé®'
  ];

  // Generar IDs de sala m√°s legibles
  function generateRoomId() {
    const adjectives = ['quiet', 'deep', 'vast', 'calm', 'bold', 'swift', 'clear', 'wild'];
    const nouns = ['river', 'forest', 'moon', 'star', 'cloud', 'wave', 'stone', 'bird'];
    const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
    const noun = nouns[Math.floor(Math.random() * nouns.length)];
    const num = Math.floor(Math.random() * 999);
    return `${adj}-${noun}-${num}`;
  }

  // Identidad del usuario
  const userIdentity = {
    color: sessionStorage.getItem('vincle_color') || COLORS[Math.floor(Math.random() * COLORS.length)],
    emoji: sessionStorage.getItem('vincle_emoji') || EMOJIS[Math.floor(Math.random() * EMOJIS.length)],
    id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5)
  };

  sessionStorage.setItem('vincle_color', userIdentity.color);
  sessionStorage.setItem('vincle_emoji', userIdentity.emoji);

  // Actualizar UI de identidad
  elements.myColor.style.background = userIdentity.color;
  elements.myEmoji.textContent = userIdentity.emoji;

  // Estado de la sala
  let currentRoom = DEFAULT_ROOM;
  let usersInRoom = 1;
  let messageCount = 0;

  // Inicializar sala
  function initRoom(roomId = currentRoom) {
    currentRoom = roomId;
    updateRoomUI();
    listenToMessages();
    updateUserPresence(true);
  }

  // Actualizar UI de la sala
  function updateRoomUI() {
    elements.roomTitle.textContent = currentRoom;
    elements.roomIdText.textContent = currentRoom;
    elements.roomInput.value = currentRoom;
    
    // Actualizar URL
    const url = new URL(window.location);
    url.searchParams.set('room', currentRoom);
    window.history.replaceState({}, '', url);
    
    // Guardar en localStorage
    localStorage.setItem('vincle_room', currentRoom);
  }

  // Referencia a la base de datos
  function getRoomRef() {
    return firebase.database().ref(`rooms/${currentRoom}`);
  }

  function getMessagesRef() {
    return getRoomRef().child('messages');
  }

  // Presencia de usuarios
  function updateUserPresence(isOnline = true) {
    const presenceRef = getRoomRef().child('presence').child(userIdentity.id);
    
    if (isOnline) {
      presenceRef.set({
        emoji: userIdentity.emoji,
        color: userIdentity.color,
        lastSeen: Date.now()
      });
      
      // Limpiar despu√©s de desconexi√≥n
      presenceRef.onDisconnect().remove();
      
      // Escuchar otros usuarios
      getRoomRef().child('presence').on('value', (snapshot) => {
        const users = snapshot.val();
        const userCount = users ? Object.keys(users).length : 1;
        usersInRoom = userCount;
        elements.onlineCount.textContent = `${userCount} en l√≠nea`;
        elements.liveUsers.textContent = userCount;
      });
    } else {
      presenceRef.remove();
    }
  }

  // Enviar mensaje
  function sendMessage(text) {
    if (!text.trim()) return;
    
    const message = {
      text: text.trim(),
      color: userIdentity.color,
      emoji: userIdentity.emoji,
      timestamp: Date.now(),
      userId: userIdentity.id,
      expiresAt: Date.now() + (MESSAGE_EXPIRY_HOURS * 3600000)
    };
    
    getMessagesRef().push(message);
    messageCount++;
    
    // Auto-scroll
    setTimeout(() => {
      elements.messages.scrollTop = elements.messages.scrollHeight;
    }, 100);
  }

  // Escuchar mensajes
  function listenToMessages() {
    elements.messages.innerHTML = '';
    
    getMessagesRef()
      .orderByChild('timestamp')
      .limitToLast(100)
      .on('child_added', (snapshot) => {
        const message = snapshot.val();
        
        // Verificar expiraci√≥n
        if (message.expiresAt && Date.now() > message.expiresAt) {
          snapshot.ref.remove();
          return;
        }
        
        addMessageToUI(message);
      });
  }

  // A√±adir mensaje al UI
  function addMessageToUI(message) {
    const isMine = message.userId === userIdentity.id;
    const messageEl = document.createElement('div');
    
    messageEl.className = `message-bubble ${isMine ? 'mine' : 'other'}`;
    messageEl.innerHTML = `
      <div class="message-sender">
        <span class="sender-emoji">${message.emoji || 'üë§'}</span>
        <span class="sender-name">${isMine ? 'T√∫' : 'An√≥nimo'}</span>
      </div>
      <div class="message-text">${escapeHtml(message.text)}</div>
      <div class="message-time">${formatTime(message.timestamp)}</div>
    `;
    
    if (isMine) {
      messageEl.style.setProperty('--accent-color', message.color);
    } else {
      messageEl.style.borderLeft = `3px solid ${message.color}`;
    }
    
    elements.messages.appendChild(messageEl);
    
    // Auto-scroll si est√° cerca del final
    const isNearBottom = elements.messages.scrollHeight - elements.messages.scrollTop - elements.messages.clientHeight < 100;
    if (isNearBottom) {
      messageEl.scrollIntoView({ behavior: 'smooth' });
    }
  }

  // Utilidades
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return 'Ahora';
    if (diff < 3600000) return `${Math.floor(diff / 60000)} min`;
    if (diff < 86400000) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
  }

  // Event Listeners
  elements.createBtn.addEventListener('click', () => {
    const roomId = elements.roomInput.value.trim() || generateRoomId();
    initRoom(roomId);
  });

  elements.copyBtn.addEventListener('click', () => {
    const url = `${window.location.origin}${window.location.pathname}?room=${encodeURIComponent(currentRoom)}`;
    navigator.clipboard.writeText(url).then(() => {
      alert('¬°Enlace copiado al portapapeles!');
    });
  });

  elements.copyRoomIdBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(currentRoom).then(() => {
      const original = elements.copyRoomIdBtn.innerHTML;
      elements.copyRoomIdBtn.innerHTML = '‚úÖ';
      setTimeout(() => {
        elements.copyRoomIdBtn.innerHTML = original;
      }, 2000);
    });
  });

  elements.sendBtn.addEventListener('click', () => {
    sendMessage(elements.textInput.value);
    elements.textInput.value = '';
    elements.textInput.style.height = 'auto';
  });

  elements.textInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      elements.sendBtn.click();
    }
  });

  // Auto-expand textarea
  elements.textInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });

  elements.clearChatBtn.addEventListener('click', () => {
    if (confirm('¬øLimpiar todos los mensajes locales? Esto no borra los mensajes del servidor.')) {
      elements.messages.innerHTML = '';
    }
  });

  elements.randomRoomBtn.addEventListener('click', () => {
    initRoom(generateRoomId());
  });

  elements.newRoomBtn.addEventListener('click', () => {
    initRoom(generateRoomId());
  });

  elements.shareRoomBtn.addEventListener('click', () => {
    const url = `${window.location.origin}${window.location.pathname}?room=${encodeURIComponent(currentRoom)}`;
    
    if (navigator.share) {
      navigator.share({
        title: '√önete a mi sala en VINCLE',
        text: 'Chatea conmigo de forma an√≥nima',
        url: url
      });
    } else {
      navigator.clipboard.writeText(url).then(() => {
        alert('Enlace copiado. Comp√°rtelo con quien quieras.');
      });
    }
  });

  // Actualizar contador de expiraci√≥n
  function updateExpiryTimer() {
    elements.expiryLabel.textContent = `${MESSAGE_EXPIRY_HOURS}h`;
    elements.expiryTimer.textContent = `${MESSAGE_EXPIRY_HOURS}h`;
  }

  // Inicializar
  document.addEventListener('DOMContentLoaded', () => {
    initRoom();
    updateExpiryTimer();
    
    // Foco autom√°tico en el input
    setTimeout(() => {
      elements.textInput.focus();
    }, 500);
  });

  // Limpiar al salir
  window.addEventListener('beforeunload', () => {
    updateUserPresence(false);
  });
</script>

</body>
</html>
