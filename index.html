<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VINCLE ‚Äî Chat an√≥nimo</title>
<style>
:root {
  --bg: #0f1720;
  --card: #0b1220;
  --accent: #60a5fa;
  --accent-hover: #3b82f6;
  --muted: #94a3b8;
  --bubble: #111827;
  --bubble-other: #1e293b;
  --glass: rgba(255,255,255,0.03);
  --border: rgba(255,255,255,0.05);
  color-scheme: dark;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:'Inter',sans-serif;background:var(--bg);overflow:hidden;display:flex;flex-direction:column;}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background-image:radial-gradient(circle at 20% 80%, rgba(96,165,250,0.05) 0%,transparent 50%),radial-gradient(circle at 80% 20%, rgba(59,130,246,0.03) 0%,transparent 50%);z-index:-1;}

header{height:56px;background:rgba(11,18,32,0.95);backdrop-filter:blur(20px);display:flex;align-items:center;justify-content:space-between;padding:0 16px;position:fixed;top:0;left:0;right:0;z-index:1000;color:#e6eef8;}
.header-brand{display:flex;align-items:center;gap:12px;text-decoration:none;}
.logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7dd3fc);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021;box-shadow:0 4px 15px rgba(96,165,250,0.3);}
.header-title{font-size:16px;font-weight:600;}
.header-subtitle{font-size:12px;color:var(--muted);margin-top:2px;}
.header-actions{display:flex;align-items:center;gap:8px;}
.header-btn{padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,0.03);color:var(--muted);cursor:pointer;font-size:14px;display:flex;align-items:center;gap:4px;transition:all 0.2s;}
.header-btn:hover{background:rgba(255,255,255,0.06);color:#e6eef8;}
.header-btn.accent{background:var(--accent);border:none;color:#021;}
.header-btn.accent:hover{background:var(--accent-hover);transform:translateY(-1px);box-shadow:0 4px 12px rgba(96,165,250,0.3);}

/* Contenedor principal */
.app-container{display:flex;flex:1;margin-top:56px;height:calc(100dvh - 56px);overflow:hidden;}
.side-panel{width:280px;background:var(--card);backdrop-filter:blur(10px);border-radius:16px;border:1px solid var(--border);padding:16px;display:flex;flex-direction:column;gap:16px;overflow-y:auto;transition:transform 0.3s ease;box-shadow:0 8px 32px rgba(0,0,0,0.2);}
.panel-section{display:flex;flex-direction:column;gap:8px;}
.section-title{font-size:12px;color:var(--muted);text-transform:uppercase;font-weight:500;}
.identity-badge{display:flex;align-items:center;gap:12px;padding:12px;background:var(--glass);border-radius:12px;border:1px solid var(--border);}
.emoji-large{font-size:24px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.03);border-radius:10px;}
.color-dot{width:20px;height:20px;border-radius:50%;border:2px solid rgba(255,255,255,0.1);}
.identity-info{flex:1;}
.identity-name{font-weight:600;font-size:14px;color:#e6eef8;}
.identity-sub{font-size:11px;color:var(--muted);margin-top:2px;}
.styled-input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,0.02);color:#e6eef8;font-size:14px;transition:all 0.2s;}
.styled-input:focus{outline:none;border-color:var(--accent);background:rgba(255,255,255,0.03);box-shadow:0 0 0 3px rgba(96,165,250,0.1);}
.button-group{display:flex;gap:8px;}
.btn-primary{flex:1;padding:10px;border:none;border-radius:10px;background:var(--accent);color:#021;font-weight:600;cursor:pointer;font-size:14px;}
.btn-primary:hover{background:var(--accent-hover);transform:translateY(-1px);box-shadow:0 4px 12px rgba(96,165,250,0.3);}
.btn-secondary{padding:10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;font-size:14px;}
.btn-secondary:hover{background:rgba(255,255,255,0.03);color:#e6eef8;border-color:rgba(255,255,255,0.1);}
.divider{height:1px;background:var(--border);margin:16px 0;}
.stats-bar{display:flex;align-items:center;gap:16px;padding:8px 0;font-size:12px;color:var(--muted);}
.stat-item{display:flex;align-items:center;gap:4px;}

/* Chat principal */
.chat-container{flex:1;background:var(--card);backdrop-filter:blur(10px);border-radius:16px;border:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.2);}
.chat-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
.room-info{display:flex;flex-direction:column;gap:2px;}
.room-name{font-weight:600;font-size:14px;display:flex;align-items:center;gap:6px;color:#e6eef8;}
.room-id{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:4px;}
.copy-icon{cursor:pointer;opacity:0.6;transition:opacity 0.2s;}
.copy-icon:hover{opacity:1;}
.room-meta{display:flex;flex-direction:column;align-items:flex-end;gap:2px;}
.expiry-info{font-size:11px;color:var(--muted);}
.online-count{font-size:11px;color:#10b981;display:flex;align-items:center;gap:4px;}

/* Mensajes */
.messages-area{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01) 0%, transparent 100%);scroll-behavior:smooth;}
.message-bubble{max-width:75%;padding:12px 16px;border-radius:18px;position:relative;line-height:1.5;word-break:break-word;animation:messageAppear 0.3s ease-out;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
@keyframes messageAppear{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.message-bubble.other{align-self:flex-start;background:var(--bubble-other);border-bottom-left-radius:6px;}
.message-bubble.mine{align-self:flex-end;background:linear-gradient(135deg,var(--accent),#7dd3fc);color:#021;border-bottom-right-radius:6px;}
.message-sender{display:flex;align-items:center;gap:6px;margin-bottom:6px;}
.sender-emoji{font-size:14px;}
.sender-name{font-weight:600;font-size:12px;}
.message-text{font-size:14px;line-height:1.4;}
.message-time{font-size:10px;opacity:0.7;margin-top:4px;text-align:right;}

/* Composer */
.message-composer{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:center;background:rgba(11,18,32,0.9);flex-shrink:0;}
.composer-input{flex:1;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,0.02);color:#e6eef8;font-size:14px;resize:none;min-height:40px;max-height:100px;line-height:1.4;}
.composer-input:focus{outline:none;border-color:var(--accent);background:rgba(255,255,255,0.03);box-shadow:0 0 0 3px rgba(96,165,250,0.1);}
.send-button{padding:10px 16px;border-radius:12px;border:none;background:var(--accent);color:#021;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px;min-width:80px;justify-content:center;}
.send-button:hover:not(:disabled){background:var(--accent-hover);transform:translateY(-1px);box-shadow:0 4px 12px rgba(96,165,250,0.3);}
.send-button:disabled{opacity:0.5;cursor:not-allowed;}

/* Indicador de escritura */
.typing-indicator{display:flex;align-items:center;gap:4px;padding:8px 12px;background:var(--bubble-other);border-radius:18px;align-self:flex-start;width:fit-content;margin-left:12px;}
.typing-dot{width:5px;height:5px;border-radius:50%;background:var(--muted);animation:typing 1.4s infinite ease-in-out;}
.typing-dot:nth-child(1){animation-delay:-0.32s;}
.typing-dot:nth-child(2){animation-delay:-0.16s;}
.typing-dot:nth-child(3){animation-delay:0;}
@keyframes typing{0%,80%,100%{transform:scale(0.6);opacity:0.6;}40%{transform:scale(1);opacity:1;}}

/* Scrollbar */
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-track{background:rgba(255,255,255,0.02);border-radius:3px;}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.2);}

/* Mobile responsive */
@media(max-width:768px){
  .app-container{flex-direction:column;}
  .side-panel{position:fixed;top:56px;bottom:0;left:0;width:260px;transform:translateX(-100%);z-index:999;transition:transform 0.3s;}
  .side-panel.active{transform:translateX(0);}
  .chat-container{border-radius:0;border:none;height:100%;flex:1;}
  .message-bubble{max-width:85%;}
  .messages-area{padding:12px;}
  .message-composer{padding:10px;}
}
</style>
</head>
<body>

<header>
  <a href="#" class="header-brand">
    <div class="logo">V</div>
    <div>
      <div class="header-title">VINCLE</div>
      <div class="header-subtitle">Chat an√≥nimo ‚Ä¢ Sin registro</div>
    </div>
  </a>
  <div class="header-actions">
    <button id="menuBtn" class="header-btn">‚ò∞</button>
    <button id="newRoomBtn" class="header-btn accent">‚ú®</button>
  </div>
</header>

<div class="app-container">
  <!-- Panel lateral -->
  <aside class="side-panel" id="sidePanel">
    <div class="panel-section">
      <h3 class="section-title">Tu identidad</h3>
      <div class="identity-badge">
        <div class="emoji-large" id="myEmoji">üî∑</div>
        <div class="color-dot" id="myColor"></div>
        <div class="identity-info">
          <div class="identity-name" id="anonLabel">An√≥nimo</div>
          <div class="identity-sub">Color y emoji √∫nicos</div>
        </div>
      </div>
    </div>

    <div class="panel-section">
      <h3 class="section-title">Gestionar sala</h3>
      <input type="text" id="roomInput" class="styled-input" placeholder="ID de sala" />
      <div class="button-group">
        <button id="createBtn" class="btn-primary">Unirse/Crear</button>
        <button id="copyBtn" class="btn-secondary">Copiar enlace</button>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:8px;">
        Comparte el enlace. Mensajes se borran despu√©s de 24h.
      </div>
    </div>

    <div class="divider"></div>

    <div class="panel-section">
      <h3 class="section-title">Acciones r√°pidas</h3>
      <button id="clearChatBtn" class="btn-secondary">üóëÔ∏è Limpiar chat local</button>
      <button id="randomRoomBtn" class="btn-secondary">üé≤ Sala aleatoria</button>
      <button id="shareRoomBtn" class="btn-secondary">üì§ Compartir sala</button>
    </div>

    <div class="divider"></div>

    <div class="stats-bar">
      <div class="stat-item">üïí <span id="expiryLabel">24h</span></div>
      <div class="stat-item">üë§ <span id="onlineCount">1</span> en l√≠nea</div>
    </div>
  </aside>

  <!-- Chat principal -->
  <main class="chat-container">
    <div class="chat-header">
      <div class="room-info">
        <div class="room-name">Sala: <span id="roomTitle">Cargando...</span></div>
        <div class="room-id">ID: <span id="roomIdText">-</span> <span class="copy-icon" id="copyRoomIdBtn" title="Copiar ID">üìã</span></div>
      </div>
      <div class="room-meta">
        <div class="expiry-info">Expira en <span id="expiryTimer">24h</span></div>
        <div class="online-count"><span class="status-dot"></span> <span id="liveUsers">1</span></div>
      </div>
    </div>

    <div class="messages-area" id="messages">
      <div class="message-bubble other">
        <div class="message-sender"><span class="sender-emoji">üëã</span><span class="sender-name">Sistema</span></div>
        <div class="message-text">Bienvenido a VINCLE. Tu identidad es an√≥nima.</div>
        <div class="message-time">Ahora</div>
      </div>
    </div>

    <div class="message-composer">
      <textarea id="textInput" class="composer-input" placeholder="Escribe un mensaje..." rows="1"></textarea>
      <button id="sendBtn" class="send-button">‚Üó</button>
    </div>
  </main>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyXMvncuf1Jhux5dVzDJ_VQe3cw3tIntt",
  authDomain: "vincle-e76dd.firebaseapp.com",
  databaseURL: "https://vincle-e76dd-default-rtdb.firebaseio.com",
  projectId: "vincle-e76dd",
  storageBucket: "vincle-e76dd.firebasestorage.app",
  messagingSenderId: "11807936515",
  appId: "1:11807936515:web:ff67d9da38e956ff62cee6"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// --- Elementos DOM ---
const q=id=>document.getElementById(id);
const roomInput=q('roomInput'),createBtn=q('createBtn'),copyBtn=q('copyBtn');
const messagesEl=q('messages'),textInput=q('textInput'),sendBtn=q('sendBtn');
const roomTitle=q('roomTitle'),roomIdText=q('roomIdText'),myColorEl=q('myColor'),myEmojiEl=q('myEmoji');
const clearChatBtn=q('clearChatBtn'),randomRoomBtn=q('randomRoomBtn');
const expiryLabel=q('expiryLabel'),expiryTimer=q('expiryTimer');
const sidePanel=q('sidePanel'),menuBtn=q('menuBtn');

// --- Identidad ---
const COLORS=['#f97316','#fb7185','#60a5fa','#34d399','#f59e0b','#a78bfa','#ef4444'];
const EMOJIS=['üî∑','üî∂','üî∫','üîµ','üü£','üü¢','üåø','‚ú®','‚ö°','üåô','‚òÄÔ∏è','üî•]()
const pickRandom = arr => arr[Math.floor(Math.random()*arr.length)];

const sessionColor = sessionStorage.getItem('vincle_color') || pickRandom(COLORS);
const sessionEmoji = sessionStorage.getItem('vincle_emoji') || pickRandom(EMOJIS);

sessionStorage.setItem('vincle_color', sessionColor);
sessionStorage.setItem('vincle_emoji', sessionEmoji);

myColorEl.style.background = sessionColor;
myEmojiEl.textContent = sessionEmoji;

// --- Sala ---
const MESSAGE_EXPIRY_HOURS = 24;
const urlParams = new URLSearchParams(window.location.search);
let currentRoom = urlParams.get('room') || localStorage.getItem('vincle_room') || generateRandomId(7);

function generateRandomId(length=7){
  const chars='abcdefghijklmnopqrstuvwxyz0123456789';
  let res='';
  for(let i=0;i<length;i++) res+=chars.charAt(Math.floor(Math.random()*chars.length));
  return res;
}

function setRoom(roomId){
  currentRoom=roomId;
  roomTitle.textContent = roomId;
  roomIdText.textContent = roomId;
  roomInput.value = roomId;
  localStorage.setItem('vincle_room', roomId);
  const url=new URL(window.location);
  url.searchParams.set('room',roomId);
  window.history.replaceState({},'',url);
  expiryLabel.textContent=MESSAGE_EXPIRY_HOURS+'h';
  expiryTimer.textContent=MESSAGE_EXPIRY_HOURS+'h';
  listenToMessages();
}

// --- Firebase ---
function getMessagesRef(){return database.ref('rooms/'+currentRoom+'/messages');}

function sendMessage(text){
  if(!text.trim()) return;
  const now = Date.now();
  const messageData = {text:text.trim(),color:sessionColor,emoji:sessionEmoji,ts:now,expiry:now+MESSAGE_EXPIRY_HOURS*3600000};
  getMessagesRef().push(messageData);
  textInput.value=''; textInput.style.height='auto';
}

function createMessageBubble(message,isMine){
  const bubble=document.createElement('div');
  bubble.className=`message-bubble ${isMine?'mine':'other'}`;
  const timeStr=formatTime(new Date(message.ts||Date.now()));
  bubble.innerHTML=`
    <div class="message-sender">
      <span class="sender-emoji">${message.emoji||'üë§'}</span>
      <span class="sender-name">${isMine?'T√∫':'An√≥nimo'}</span>
    </div>
    <div class="message-text">${escapeHtml(message.text)}</div>
    <div class="message-time">${timeStr}</div>
  `;
  return bubble;
}

function listenToMessages(){
  messagesEl.innerHTML='';
  // Mensaje bienvenida
  const welcomeBubble=document.createElement('div');
  welcomeBubble.className='message-bubble other';
  welcomeBubble.innerHTML=`
    <div class="message-sender"><span class="sender-emoji">üëã</span><span class="sender-name">Sistema</span></div>
    <div class="message-text">Bienvenido a la sala <strong>${currentRoom}</strong>. Tu identidad es an√≥nima. Los mensajes se borran autom√°ticamente despu√©s de ${MESSAGE_EXPIRY_HOURS} horas.</div>
    <div class="message-time">Ahora</div>
  `;
  messagesEl.appendChild(welcomeBubble);

  getMessagesRef().limitToLast(100).on('child_added',snapshot=>{
    const msg=snapshot.val(); if(!msg) return;
    if(msg.expiry && Date.now()>msg.expiry) return;
    const isMine=(msg.color===sessionColor && msg.emoji===sessionEmoji);
    const bubble=createMessageBubble(msg,isMine);
    messagesEl.appendChild(bubble);
    setTimeout(()=>messagesEl.scrollTop=messagesEl.scrollHeight,100);
  });
}

// --- Utilidades ---
function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML;}
function formatTime(date){
  const diff=new Date()-date;
  if(diff<60000) return 'Ahora';
  if(diff<3600000) return `${Math.floor(diff/60000)} min`;
  if(diff<86400000) return date.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  return date.toLocaleDateString([], {month:'short',day:'numeric'});
}

// --- Eventos ---
createBtn.addEventListener('click',()=>{const r=(roomInput.value||'').trim()||generateRandomId(7); setRoom(r);});
copyBtn.addEventListener('click',()=>{navigator.clipboard.writeText(window.location.origin+window.location.pathname+'?room='+encodeURIComponent(currentRoom)).then(()=>alert('¬°Enlace copiado al portapapeles!'));});
q('copyRoomIdBtn').addEventListener('click',()=>{navigator.clipboard.writeText(currentRoom).then(()=>{const orig=q('copyRoomIdBtn').innerHTML;q('copyRoomIdBtn').innerHTML='‚úÖ';setTimeout(()=>q('copyRoomIdBtn').innerHTML=orig,2000);});});

sendBtn.addEventListener('click',()=>sendMessage(textInput.value));
textInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage(textInput.value);}});
textInput.addEventListener('input',function(){this.style.height='auto';this.style.height=this.scrollHeight+'px';});

clearChatBtn.addEventListener('click',()=>{if(confirm('¬øLimpiar chat local?')){messagesEl.innerHTML='';listenToMessages();}});
randomRoomBtn.addEventListener('click',()=>setRoom(generateRandomId(7)));
newRoomBtn.addEventListener('click',()=>setRoom(generateRandomId(7)));

menuBtn.addEventListener('click',()=>sidePanel.classList.toggle('active'));

q('shareRoomBtn').addEventListener('click',()=>{
  const url=window.location.href;
  if(navigator.share){navigator.share({title:'√önete a mi sala en VINCLE',text:'Chatea de forma an√≥nima',url});}
  else{navigator.clipboard.writeText(url).then(()=>alert('Enlace copiado. Comp√°rtelo con quien quieras.'));}
});

document.addEventListener('DOMContentLoaded',()=>{setRoom(currentRoom);setTimeout(()=>textInput.focus(),500);});
document.addEventListener('keydown',e=>{if(e.key==='Escape'){textInput.blur();sidePanel.classList.remove('active');}});
</script>

</body>
</html>
